# Tóm Tắt Cập Nhật Script Seed Cart và Order

## 📋 Tổng Quan

Đã phân tích và cập nhật script seed dữ liệu cho các module Cart và Order trong hệ thống E-commerce NestJS, bao gồm việc xử lý hình ảnh S3 và cập nhật schema mới.

## 🔧 Các Thay Đổi Chính

### 1. Cập Nhật Schema Order

- **Vấn đề**: Model Order đã được cập nhật với trường `paymentId` bắt buộc
- **Giải pháp**:
  - Thêm import `PaymentStatus` từ constants
  - Tạo Payment record trước khi tạo Order
  - Thêm `paymentId` vào Order creation
  - Cập nhật thống kê để bao gồm số lượng payments

### 2. Xử Lý Hình Ảnh Đa Dạng

- **Vấn đề**: Chỉ sử dụng một ảnh duy nhất cho tất cả sản phẩm
- **Giải pháp**:
  - Thêm danh sách 4 URL ảnh S3 khác nhau
  - Tạo helper functions để chọn ảnh ngẫu nhiên
  - Mỗi Product có 3-4 ảnh ngẫu nhiên
  - Mỗi SKU có ảnh riêng biệt
  - ProductSKUSnapshot sử dụng ảnh fallback

### 3. Cải Thiện Logic Tạo Dữ Liệu

- **Tính toán tổng tiền**: Tính tổng giá trị order dựa trên SKU và quantity
- **Payment Status**: Random status cho payment (PENDING, SUCCESS, FAILED)
- **Order Status**: Random status cho order (PENDING_PAYMENT, PENDING_PICKUP, DELIVERED)

## 📁 Files Đã Cập Nhật

### 1. `initialScript/add-cart-order-data.ts`

```typescript
// Thêm import PaymentStatus
import { PaymentStatus } from 'src/shared/constants/payment.constant'

// Thêm danh sách ảnh đa dạng
const SAMPLE_IMAGE_URLS = [
  'https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/d79f483f-61d7-42dc-83ef-0e5b9037a275.jpg',
  'https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/a1affb40-aafc-4de1-a808-6efe7a41e85a.png',
  'https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/images/19ac0360-d1cd-496b-9cb9-f2aea4e440df.jpg',
  'https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/images/a1bf30cd-647f-4699-9765-8053f2e75a72.jpg',
]

// Helper functions
const pickRandom = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)]
const pickImagesForProduct = (): string[] => {
  const shuffled = [...SAMPLE_IMAGE_URLS].sort(() => 0.5 - Math.random())
  const count = Math.min(4, Math.max(3, Math.floor(Math.random() * 4)))
  return shuffled.slice(0, count)
}

// Logic tạo Payment trước Order
const payment = await prisma.payment.create({
  data: {
    status: [PaymentStatus.PENDING, PaymentStatus.SUCCESS, PaymentStatus.FAILED][Math.floor(Math.random() * 3)],
  },
})

const order = await prisma.order.create({
  data: {
    // ... other fields
    paymentId: payment.id,
  },
})
```

### 2. `docs/postman/NestJS_Ecommerce_API.postman_collection.json`

- Đã cập nhật collection Postman với các API endpoints cho Cart và Order
- Bao gồm các request mẫu với headers và body phù hợp

## 🚀 Cách Sử Dụng

### 1. Chạy Script Seed

```bash
# Chạy script tạo dữ liệu mẫu
npx ts-node initialScript/add-cart-order-data.ts
```

### 2. Test API với Postman

- Import file `docs/postman/NestJS_Ecommerce_API.postman_collection.json`
- Sử dụng các request trong thư mục "Cart" và "Orders"

## 📊 Dữ Liệu Được Tạo

### Users

- 3 khách hàng (customers)
- 2 sellers (shop owners)
- Mỗi user có avatar từ S3

### Products & SKUs

- 5 sản phẩm với variants khác nhau
- Mỗi product có 3-4 ảnh ngẫu nhiên
- SKUs với giá và stock ngẫu nhiên
- Mỗi SKU có ảnh riêng biệt

### Cart & Orders

- Cart items cho mỗi khách hàng
- Orders với payment records
- ProductSKUSnapshots cho order history

### Thống Kê

- Users: ~5 records
- Brands: 5 records
- Categories: 4 records
- Products: 5 records
- SKUs: ~20-30 records (tùy variants)
- Cart Items: ~9-15 records
- Orders: ~3-6 records
- Payments: ~3-6 records
- Product Snapshots: ~10-20 records

## 🔗 URLs Hình Ảnh S3

1. [Ảnh 1](https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/d79f483f-61d7-42dc-83ef-0e5b9037a275.jpg)
2. [Ảnh 2](https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/a1affb40-aafc-4de1-a808-6efe7a41e85a.png)
3. [Ảnh 3](https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/images/19ac0360-d1cd-496b-9cb9-f2aea4e440df.jpg)
4. [Ảnh 4](https://ecommerce-super-nestjs.s3.ap-southeast-1.amazonaws.com/images/a1bf30cd-647f-4699-9765-8053f2e75a72.jpg)

## ✅ Kiểm Tra Chất Lượng

- ✅ ESLint: Không có lỗi
- ✅ TypeScript: Đã sửa lỗi Map iteration
- ✅ Schema: Tương thích với Prisma schema mới
- ✅ Logic: Tạo dữ liệu theo đúng thứ tự dependencies

## 🎯 Kết Quả

Script đã được cập nhật thành công để:

1. Tương thích với schema Order mới (có paymentId)
2. Sử dụng đa dạng hình ảnh S3 cho sản phẩm
3. Tạo dữ liệu mẫu phong phú cho testing
4. Cung cấp Postman collection để test API

Tất cả đã sẵn sàng để chạy và test các module Cart và Order!
