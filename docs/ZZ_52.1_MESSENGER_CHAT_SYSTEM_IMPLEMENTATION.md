# 🚀 Hệ Thống Chat Real-time Như Facebook Messenger

## 📋 Tổng quan

Đây là documentation chi tiết về việc implement hệ thống chat real-time giống Facebook Messenger cho dự án NestJS Ecommerce API. Hệ thống hỗ trợ đầy đủ các tính năng hiện đại:

### ✨ Tính năng chính:

- **Chat 1-1** (Direct Messages)
- **Group Chat** (Nhiều người tham gia với roles)
- **Real-time messaging** với Socket.io
- **Message reactions** (emoji reactions)
- **Read receipts** (tracking đã đọc tin nhắn)
- **Typing indicators** (hiển thị ai đang gõ)
- **File attachments** (images, videos, documents)
- **Message editing/deleting** (cho bản thân hoặc admin)
- **Online/offline status** tracking
- **Message search** với faceted search
- **Conversation management** (archive, mute, leave)

---

## 🏗️ Kiến trúc hệ thống

### 1. Database Schema

#### **Core Models**

**Conversation**: Container chính cho cuộc trò chuyện

```prisma
model Conversation {
  id                String                @id @default(cuid())
  type              ConversationType      @default(DIRECT) // DIRECT or GROUP
  name              String?               @db.VarChar(500) // Tên nhóm
  description       String?               // Mô tả nhóm
  avatar            String?               @db.VarChar(1000) // Avatar nhóm
  ownerId           Int?                  // Chủ nhóm
  lastMessage       String?               // Preview tin nhắn cuối
  lastMessageAt     DateTime?             // Thời gian tin nhắn cuối
  isArchived        Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}
```

**ConversationMember**: Quản lý thành viên trong cuộc trò chuyện

```prisma
model ConversationMember {
  id             String                @id @default(cuid())
  conversationId String
  userId         Int
  role           ConversationRole      @default(MEMBER) // ADMIN, MODERATOR, MEMBER
  joinedAt       DateTime              @default(now())
  lastReadAt     DateTime?             // Lần cuối đọc tin nhắn
  unreadCount    Int                   @default(0)      // Số tin nhắn chưa đọc
  isActive       Boolean               @default(true)   // Còn trong conversation không
  isMuted        Boolean               @default(false)  // Tắt thông báo
  mutedUntil     DateTime?
}
```

**ConversationMessage**: Tin nhắn với đầy đủ features

```prisma
model ConversationMessage {
  id             String              @id @default(cuid())
  conversationId String
  fromUserId     Int
  content        String?             // Nội dung text
  type           MessageType         @default(TEXT)
  replyToId      String?             // Reply to message
  isEdited       Boolean             @default(false)
  editedAt       DateTime?
  isDeleted      Boolean             @default(false)
  deletedAt      DateTime?
  deletedForEveryone Boolean          @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}
```

#### **Supporting Models**

- **MessageAttachment**: File đính kèm với metadata đầy đủ
- **MessageReaction**: Emoji reactions với user tracking
- **MessageReadReceipt**: Tracking ai đã đọc tin nhắn nào
- **TypingIndicator**: Real-time typing status

### 2. Module Structure

```
src/routes/conversation/
├── conversation.module.ts          # Main module
├── conversation.controller.ts      # REST API endpoints
├── conversation.service.ts         # Business logic for conversations
├── conversation.repo.ts           # Database operations for conversations
├── conversation.dto.ts            # Request/Response DTOs with validation
├── message.service.ts             # Business logic for messages
├── message.repo.ts               # Database operations for messages
└── enhanced-chat.gateway.ts      # WebSocket real-time handlers
```

---

## 📡 REST API Endpoints

### Conversation Management

```http
GET    /conversations                    # Danh sách conversations (pagination + filters)
GET    /conversations/stats              # Thống kê conversations của user
GET    /conversations/:id               # Chi tiết conversation
POST   /conversations/direct            # Tạo chat 1-1
POST   /conversations/group             # Tạo group chat
PUT    /conversations/:id               # Update thông tin group
POST   /conversations/:id/archive       # Lưu trữ conversation
POST   /conversations/:id/unarchive     # Khôi phục conversation
POST   /conversations/:id/mute          # Tắt thông báo
POST   /conversations/:id/unmute        # Bật thông báo
DELETE /conversations/:id/leave         # Rời khỏi conversation
```

### Member Management

```http
GET    /conversations/:id/members       # Danh sách thành viên
POST   /conversations/:id/members       # Thêm thành viên (group only)
DELETE /conversations/:id/members/:memberId  # Xóa thành viên
PUT    /conversations/:id/members/:memberId/role  # Cập nhật role
```

### Message Management

```http
GET    /conversations/:id/messages      # Lấy messages (cursor pagination)
GET    /conversations/:id/messages/stats # Thống kê messages
GET    /conversations/messages/search   # Tìm kiếm messages
POST   /conversations/messages          # Gửi tin nhắn
GET    /conversations/messages/:id      # Chi tiết tin nhắn
PUT    /conversations/messages/:id      # Chỉnh sửa tin nhắn
DELETE /conversations/messages/:id      # Xóa tin nhắn
```

### Message Interactions

```http
POST   /conversations/messages/read              # Đánh dấu đã đọc
POST   /conversations/messages/:id/react         # React tin nhắn
DELETE /conversations/messages/:id/react         # Xóa reaction
GET    /conversations/messages/:id/reactions/stats     # Thống kê reactions
GET    /conversations/messages/:id/read-receipts/stats # Thống kê đã đọc
```

---

## 🔌 WebSocket Events

### Connection Events

```typescript
// Client to Server
'join_conversation' // Tham gia conversation room
'leave_conversation' // Rời conversation room

// Server to Client
'connected' // Xác nhận kết nối thành công
'user_joined_conversation' // User tham gia conversation
'user_left_conversation' // User rời conversation
'user_online' // User online
'user_offline' // User offline
```

### Message Events

```typescript
// Client to Server
'send_message' // Gửi tin nhắn
'edit_message' // Sửa tin nhắn
'delete_message' // Xóa tin nhắn

// Server to Client
'new_message' // Tin nhắn mới
'message_sent' // Xác nhận gửi thành công
'message_edited' // Tin nhắn đã được sửa
'message_deleted' // Tin nhắn đã được xóa
'message_error' // Lỗi khi gửi tin nhắn
```

### Interaction Events

```typescript
// Client to Server
'typing_start' // Bắt đầu gõ
'typing_stop' // Dừng gõ
'mark_as_read' // Đánh dấu đã đọc
'react_to_message' // React tin nhắn
'remove_reaction' // Xóa reaction

// Server to Client
'user_typing' // User đang gõ
'user_stopped_typing' // User dừng gõ
'messages_read' // Tin nhắn đã được đọc
'message_reaction_updated' // Reaction được thêm/xóa
```

---

## ⚡ Key Features Implementation

### 1. Real-time Messaging

**Client gửi tin nhắn:**

```typescript
socket.emit('send_message', {
  conversationId: 'conv_123',
  content: 'Hello!',
  type: 'TEXT',
  tempId: 'temp_' + Date.now(), // Deduplication
})
```

**Server xử lý và broadcast:**

```typescript
@SubscribeMessage('send_message')
async handleSendMessage(client: AuthenticatedSocket, data: SendMessageData) {
  // 1. Validate permissions & content
  // 2. Save to database
  const message = await this.messageService.sendMessage(client.userId, data)

  // 3. Broadcast to conversation members
  this.server.to(`conversation:${data.conversationId}`).emit('new_message', {
    message,
    tempId: data.tempId
  })

  // 4. Send confirmation to sender
  client.emit('message_sent', { message, tempId: data.tempId })

  // 5. Send offline notifications
  await this.sendOfflineNotifications(data.conversationId, message, client.userId)
}
```

### 2. Typing Indicators

**Implementation với auto-cleanup:**

```typescript
@SubscribeMessage('typing_start')
async handleTypingStart(client: AuthenticatedSocket, data: TypingData) {
  // Add to typing list
  this.typingUsers.get(data.conversationId)?.add(client.userId)

  // Notify others (exclude sender)
  client.to(`conversation:${data.conversationId}`).emit('user_typing', {
    userId: client.userId,
    user: client.user
  })

  // Auto-remove after 10 seconds
  setTimeout(() => {
    this.removeUserFromTyping(data.conversationId, client.userId)
  }, 10000)
}
```

### 3. Read Receipts

**Mark messages as read:**

```typescript
async markAsRead(conversationId: string, userId: number, messageId?: string) {
  if (messageId) {
    // Mark specific message
    await this.messageRepo.markAsRead(messageId, userId)
  } else {
    // Mark all unread messages
    await this.messageRepo.markConversationAsRead(conversationId, userId)
  }

  // Update member's last read timestamp
  await this.conversationRepo.updateMemberLastRead(conversationId, userId)
}
```

### 4. Message Reactions

**Toggle reaction behavior:**

```typescript
async reactToMessage(messageId: string, userId: number, emoji: string) {
  // Check if user already reacted with this emoji
  const existingReaction = await this.messageRepo.findReaction(messageId, userId, emoji)

  if (existingReaction) {
    // Remove existing reaction (toggle off)
    await this.messageRepo.removeReaction(messageId, userId, emoji)
    return { action: 'removed', emoji }
  } else {
    // Add new reaction (toggle on)
    const reaction = await this.messageRepo.addReaction(messageId, userId, emoji)
    return { action: 'added', reaction }
  }
}
```

### 5. File Attachments

**Support multiple file types:**

```typescript
interface MessageAttachment {
  type: 'IMAGE' | 'VIDEO' | 'AUDIO' | 'DOCUMENT'
  fileName: string
  fileUrl: string
  fileSize?: number
  mimeType?: string
  thumbnail?: string // For images/videos
  width?: number // For images/videos
  height?: number // For images/videos
  duration?: number // For audio/videos (seconds)
}
```

### 6. Advanced Search

**Search với faceted results:**

```typescript
async searchMessages(userId: number, query: string, options: SearchOptions) {
  // Get user's accessible conversations
  const conversationIds = await this.getUserConversationIds(userId)

  // Search with filters
  const results = await this.messageRepo.searchMessages(conversationIds, query, {
    type: options.type,        // Filter by message type
    fromUserId: options.fromUserId, // Filter by sender
    dateFrom: options.dateFrom,     // Date range
    dateTo: options.dateTo,
  })

  // Return with facets for filtering
  return {
    data: results.data,
    pagination: results.pagination,
    facets: {
      byType: { TEXT: 45, IMAGE: 12, VIDEO: 3 },
      byUser: { '123': 20, '456': 15 },
      byConversation: { 'conv_1': 30, 'conv_2': 25 }
    }
  }
}
```

---

## 🔐 Security & Authorization

### 1. WebSocket Authentication

```typescript
async handleConnection(client: Socket) {
  try {
    // Extract JWT token
    const token = client.handshake.auth.authorization?.split(' ')[1]

    // Verify token
    const payload = await this.tokenService.verifyAccessToken(token)

    // Get user info
    const user = await this.userRepo.findById(payload.userId)
    if (!user || user.status !== 'ACTIVE') {
      throw new Error('User not found or inactive')
    }

    // Attach to socket
    client.userId = user.id
    client.user = user

  } catch (error) {
    client.disconnect(true)
  }
}
```

### 2. Permission Checking

**Conversation access:**

```typescript
async isUserMember(conversationId: string, userId: number): Promise<boolean> {
  const member = await this.prisma.conversationMember.findUnique({
    where: { conversationId_userId: { conversationId, userId } }
  })
  return member?.isActive ?? false
}
```

**Role-based permissions:**

```typescript
// Only admins can update group info
const userRole = await this.conversationRepo.getUserRole(conversationId, userId)
if (userRole !== 'ADMIN') {
  throw new ForbiddenException('Chỉ quản trị viên mới có thể cập nhật thông tin nhóm')
}
```

### 3. Input Validation

**Comprehensive validation với Zod:**

```typescript
export const SendMessageBodySchema = z.object({
  conversationId: z.string().cuid(),
  content: z.string().min(1).max(10000).optional(),
  type: z.enum(['TEXT', 'IMAGE', 'VIDEO', 'AUDIO', 'FILE', 'STICKER', 'LOCATION', 'CONTACT']),
  attachments: z
    .array(
      z.object({
        type: z.enum(['IMAGE', 'VIDEO', 'AUDIO', 'DOCUMENT']),
        fileName: z.string().min(1).max(500),
        fileUrl: z.string().url(),
        fileSize: z
          .number()
          .int()
          .positive()
          .max(100 * 1024 * 1024), // 100MB limit
      }),
    )
    .max(10)
    .optional(),
})
```

---

## 🚀 Performance Optimizations

### 1. Database Indexing

```prisma
// Optimized indexes for common queries
@@index([conversationId, createdAt])  // Message pagination
@@index([userId, isActive])           // Active members
@@index([lastMessageAt])              // Conversation sorting
@@index([type])                       // Message type filtering
@@index([fromUserId])                 // Sender filtering
@@index([expiresAt])                  // Typing indicator cleanup
```

### 2. Efficient Pagination

**Cursor-based pagination cho messages:**

```typescript
async findConversationMessages(conversationId: string, options: {
  limit: number
  before?: string  // Cursor để load tin nhắn cũ hơn
  after?: string   // Cursor để load tin nhắn mới hơn
}) {
  const where = { conversationId, isDeleted: false }

  // Cursor-based filtering
  if (options.before) {
    const beforeMessage = await this.getMessageCreatedAt(options.before)
    where.createdAt = { lt: beforeMessage }
  }

  // Fetch with limit
  const messages = await this.prisma.conversationMessage.findMany({
    where,
    orderBy: { createdAt: 'desc' },
    take: options.limit,
    include: this.getMessageInclude()
  })

  return {
    data: messages.reverse(), // Chronological order
    hasMore: messages.length === options.limit,
    nextCursor: messages[messages.length - 1]?.id,
    prevCursor: messages[0]?.id
  }
}
```

### 3. Smart Caching Strategy

**In-memory caching cho hot data:**

```typescript
class EnhancedChatGateway {
  private onlineUsers = new Map<number, Set<string>>() // userId -> socketIds
  private typingUsers = new Map<string, Set<number>>() // conversationId -> userIds
  private userSockets = new Map<string, AuthenticatedSocket>() // socketId -> socket

  // Auto-cleanup expired data
  constructor() {
    setInterval(() => this.cleanupTypingIndicators(), 30000)
  }
}
```

### 4. Optimized Queries

**Batch operations:**

```typescript
// Mark multiple messages as read in one operation
async markConversationAsRead(conversationId: string, userId: number) {
  // Get all unread message IDs
  const messages = await this.prisma.conversationMessage.findMany({
    where: {
      conversationId,
      fromUserId: { not: userId },
      readReceipts: { none: { userId } }
    },
    select: { id: true }
  })

  // Batch create read receipts
  if (messages.length > 0) {
    await this.prisma.messageReadReceipt.createMany({
      data: messages.map(msg => ({ messageId: msg.id, userId })),
      skipDuplicates: true
    })
  }
}
```

---

## 📊 Monitoring & Analytics

### 1. Logging Strategy

```typescript
// Structured logging với context
this.logger.log(`Message sent by user ${userId} in conversation ${conversationId}`, {
  userId,
  conversationId,
  messageId: message.id,
  messageType: message.type,
  hasAttachments: message.attachments.length > 0,
  timestamp: new Date().toISOString(),
})
```

### 2. Metrics Tracking

```typescript
// Key metrics to monitor
interface ChatMetrics {
  activeConnections: number
  messagesPerSecond: number
  averageResponseTime: number
  errorRate: number
  onlineUsers: number
  conversationActivity: Record<string, number>
}
```

### 3. Health Checks

```typescript
@Get('health')
async healthCheck() {
  return {
    status: 'OK',
    timestamp: new Date(),
    metrics: {
      activeConnections: this.chatGateway.getOnlineUsers().length,
      memoryUsage: process.memoryUsage(),
      uptime: process.uptime()
    }
  }
}
```

---

## 🔧 Setup & Installation

### 1. Database Migration

```bash
# Copy nội dung từ prisma/chat-schema-update.prisma vào prisma/schema.prisma
# Sau đó chạy migration
npx prisma db push
npx prisma generate
```

### 2. Module Integration

```typescript
// src/app.module.ts
@Module({
  imports: [
    // ... existing modules
    ConversationModule, // ← Thêm dòng này
  ],
})
export class AppModule {}
```

### 3. WebSocket Integration

```typescript
// src/websockets/websocket.module.ts
@Module({
  providers: [
    EnhancedChatGateway, // ← Replace ChatGateway
    PaymentGateway,
  ],
})
export class WebsocketModule {}
```

### 4. Environment Configuration

```env
# .env
REDIS_URL=redis://localhost:6379
CLIENT_URL=http://localhost:3000
JWT_SECRET=your-jwt-secret
```

---

## 🧪 Testing

### 1. Unit Tests

```typescript
describe('ConversationService', () => {
  it('should create direct conversation', async () => {
    const result = await conversationService.createDirectConversation(1, 2)
    expect(result.type).toBe('DIRECT')
    expect(result.members).toHaveLength(2)
  })

  it('should not allow duplicate direct conversations', async () => {
    await conversationService.createDirectConversation(1, 2)
    const duplicate = await conversationService.createDirectConversation(1, 2)
    // Should return existing conversation
    expect(duplicate.id).toBe(existing.id)
  })
})
```

### 2. Integration Tests

```typescript
describe('Chat WebSocket', () => {
  it('should send message real-time', async () => {
    const client1 = io('/chat', { auth: { authorization: `Bearer ${token1}` } })
    const client2 = io('/chat', { auth: { authorization: `Bearer ${token2}` } })

    // Client 2 joins conversation
    client2.emit('join_conversation', { conversationId: 'conv_123' })

    // Client 1 sends message
    client1.emit('send_message', {
      conversationId: 'conv_123',
      content: 'Hello!',
      tempId: 'temp_123',
    })

    // Client 2 should receive message
    const receivedMessage = await new Promise((resolve) => {
      client2.on('new_message', resolve)
    })

    expect(receivedMessage.message.content).toBe('Hello!')
  })
})
```

---

## 📱 Client Integration

### React/Vue.js Example

```typescript
import io from 'socket.io-client'

class ChatService {
  private socket: Socket

  connect(token: string) {
    this.socket = io('/chat', {
      auth: { authorization: `Bearer ${token}` },
    })

    this.setupEventListeners()
  }

  private setupEventListeners() {
    this.socket.on('connected', (data) => {
      console.log('Connected to chat:', data)
    })

    this.socket.on('new_message', (data) => {
      this.handleNewMessage(data.message)
    })

    this.socket.on('user_typing', (data) => {
      this.showTypingIndicator(data.user.name, data.conversationId)
    })
  }

  sendMessage(conversationId: string, content: string) {
    const tempId = 'temp_' + Date.now()

    // Optimistic UI update
    this.addMessageOptimistically({ tempId, content, conversationId })

    this.socket.emit('send_message', {
      conversationId,
      content,
      tempId,
    })
  }

  joinConversation(conversationId: string) {
    this.socket.emit('join_conversation', { conversationId })
  }
}
```

### React Native Example

```typescript
import { io } from 'socket.io-client'

export class MobileChatService {
  private socket: Socket

  async connect(token: string) {
    this.socket = io('ws://your-api.com/chat', {
      transports: ['websocket'],
      auth: { authorization: `Bearer ${token}` },
    })

    // Handle background/foreground
    AppState.addEventListener('change', this.handleAppStateChange)
  }

  private handleAppStateChange = (nextAppState: string) => {
    if (nextAppState === 'background') {
      this.socket.disconnect()
    } else if (nextAppState === 'active') {
      this.socket.connect()
    }
  }
}
```

---

## 🔮 Future Enhancements

### Phase 1: Advanced Features ⏳

- [ ] Voice messages với audio recording
- [ ] Video calls với WebRTC integration
- [ ] Message threading (reply in thread)
- [ ] Advanced @mentions với notifications
- [ ] Message translation
- [ ] Chat themes & customization

### Phase 2: Business Features ⏳

- [ ] Customer support chat integration
- [ ] Chatbot framework
- [ ] Message moderation & auto-filtering
- [ ] Chat analytics dashboard
- [ ] Scheduled messages
- [ ] Message templates

### Phase 3: Enterprise Features ⏳

- [ ] End-to-end encryption
- [ ] Message retention policies
- [ ] Compliance & audit logs
- [ ] Advanced admin controls
- [ ] API rate limiting per user
- [ ] Multi-tenant architecture

---

## 🛠️ Troubleshooting

### Common Issues

**1. Socket connection fails:**

```javascript
// Check token format
const token = localStorage.getItem('accessToken')
const socket = io('/chat', {
  auth: { authorization: `Bearer ${token}` },
})

socket.on('connect_error', (error) => {
  console.error('Connection failed:', error.message)
})
```

**2. Messages not delivered:**

```typescript
// Implement retry mechanism
socket.emit('send_message', data, (ack) => {
  if (!ack.success) {
    // Retry after delay
    setTimeout(() => this.retryMessage(data), 1000)
  }
})
```

**3. Memory leaks:**

```typescript
// Proper cleanup
useEffect(() => {
  const socket = chatService.connect(token)

  return () => {
    socket.disconnect()
    chatService.cleanup()
  }
}, [])
```

---

## 📈 Performance Benchmarks

### Target Metrics

- **Message delivery**: < 100ms
- **Connection time**: < 500ms
- **Memory usage**: < 100MB per 1000 concurrent users
- **Database queries**: < 50ms average
- **File upload**: < 5s for 10MB files

### Load Testing

```bash
# Test với Artillery
artillery run load-test.yml

# Test script example
config:
  target: 'ws://localhost:3000/chat'
  phases:
    - duration: 60
      arrivalRate: 10
scenarios:
  - name: "Send messages"
    weight: 100
    engine: socketio
    socketio:
      auth:
        authorization: "Bearer {{ $randomString() }}"
```

---

## 🎉 Kết luận

Hệ thống chat real-time này cung cấp:

✅ **Feature Complete**: Đầy đủ tính năng như Facebook Messenger
✅ **Production Ready**: Với security, validation, error handling
✅ **Scalable Architecture**: Module-based, clean separation
✅ **Performance Optimized**: Efficient queries, caching, indexing
✅ **Developer Friendly**: TypeScript, comprehensive documentation
✅ **Extensible**: Dễ dàng thêm features mới

**Files đã tạo:**

- `prisma/chat-schema-update.prisma` - Database schema
- `src/routes/conversation/` - Complete module implementation
- `docs/MESSENGER_CHAT_SYSTEM_IMPLEMENTATION.md` - Documentation

**Next steps:**

1. Copy schema updates vào `prisma/schema.prisma`
2. Run database migration
3. Add ConversationModule vào AppModule
4. Replace ChatGateway với EnhancedChatGateway
5. Test và deploy!

🚀 **Happy coding!**
