# BÃ¡o CÃ¡o PhÃ¢n TÃ­ch ProductSKUSnapshot - PHIÃŠN Báº¢N CHÃNH XÃC

## ğŸ¯ Káº¿t Luáº­n ÄÃºng

**âœ… Dá»° ÃN ÄÃƒ IMPLEMENT ProductSKUSnapshot THÃ”NG QUA NESTED WRITES TRONG PRISMA**

Sau khi Ä‘Æ°á»£c giáº£ng viÃªn chá»‰ ra vÃ  nghiÃªn cá»©u láº¡i tÃ i liá»‡u Prisma vá» [Nested Writes](https://www.prisma.io/docs/orm/prisma-client/queries/relation-queries#nested-writes), tÃ´i xÃ¡c nháº­n ráº±ng dá»± Ã¡n **ÄÃƒ** táº¡o ProductSKUSnapshot khi táº¡o order thÃ´ng qua cÆ¡ cháº¿ nested writes cá»§a Prisma.

---

## ğŸ“‹ CÃ¡ch Thá»©c Hoáº¡t Äá»™ng

### 1. Schema Relationship trong Prisma

**File: `prisma/schema.prisma`**

```prisma
model Order {
  // ... other fields
  items     ProductSKUSnapshot[]  // âœ… Quan há»‡ One-to-Many
  // ... other fields
}

model ProductSKUSnapshot {
  // ... fields
  orderId   Int?
  order     Order? @relation(fields: [orderId], references: [id])
  // ... other fields
}
```

### 2. Nested Create trong Code

**File: `src/routes/order/order.repo.ts` - Lines 159-180**

```typescript
await tx.order.create({
  data: {
    userId,
    status: OrderStatus.PENDING_PAYMENT,
    receiver: item.receiver,
    createdById: userId,
    shopId: item.shopId,
    paymentId: payment.id,

    // âœ… NESTED WRITES: Táº¡o ProductSKUSnapshot qua relation 'items'
    items: {
      create: item.cartItemIds.map((cartItemId) => {
        const cartItem = cartItemMap.get(cartItemId)!
        return {
          // âœ… CÃ¡c field nÃ y sáº½ táº¡o record ProductSKUSnapshot
          productName: cartItem.sku.product.name,
          skuPrice: cartItem.sku.price,
          image: cartItem.sku.image,
          skuId: cartItem.sku.id,
          skuValue: cartItem.sku.value,
          quantity: cartItem.quantity,
          productId: cartItem.sku.product.id,
          productTranslations: cartItem.sku.product.productTranslations.map((translation) => ({
            id: translation.id,
            name: translation.name,
            description: translation.description,
            languageId: translation.languageId,
          })),
          // orderId sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng set bá»Ÿi Prisma
        }
      }),
    },
  },
})
```

---

## ğŸ”„ CÆ¡ Cháº¿ Nested Writes cá»§a Prisma

### Theo tÃ i liá»‡u Prisma:

> **Nested writes** allow you to perform multiple database operations across related records in a single transaction. The following example **creates a user record and two related post records**:

TÆ°Æ¡ng tá»±, trong dá»± Ã¡n cá»§a báº¡n:

1. **Táº¡o Order record**
2. **Äá»“ng thá»i táº¡o multiple ProductSKUSnapshot records** thÃ´ng qua relation `items`
3. **Táº¥t cáº£ trong má»™t transaction** Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u

### Prisma sáº½ tá»± Ä‘á»™ng:

```sql
-- 1. Táº¡o Order trÆ°á»›c
INSERT INTO "Order" (userId, status, receiver, ...) VALUES (...);

-- 2. Táº¡o cÃ¡c ProductSKUSnapshot vÃ  link vá»›i Order vá»«a táº¡o
INSERT INTO "ProductSKUSnapshot" (orderId, productName, skuPrice, ...) VALUES
  (order_id, 'Product 1', 100000, ...),
  (order_id, 'Product 2', 200000, ...),
  (order_id, 'Product 3', 150000, ...);
```

---

## ğŸ“Š So SÃ¡nh Vá»›i CÃ¡ch Tiáº¿p Cáº­n Thá»§ CÃ´ng

### âŒ CÃ¡ch Thá»§ CÃ´ng (Nhiá»u Queries)

```typescript
// 1. Táº¡o Order
const order = await tx.order.create({...})

// 2. Táº¡o tá»«ng ProductSKUSnapshot
for (const item of items) {
  await tx.productSKUSnapshot.create({
    data: {
      orderId: order.id,  // Pháº£i set manually
      productName: item.name,
      // ...
    }
  })
}
```

### âœ… Nested Writes (Single Query, Atomic)

```typescript
// Táº¥t cáº£ trong má»™t operation, atomic
const order = await tx.order.create({
  data: {
    // order fields...
    items: {
      create: [...] // Prisma tá»± Ä‘á»™ng link orderId
    }
  }
})
```

---

## ğŸ Lá»£i Ãch Cá»§a Nested Writes

### 1. **Atomic Transaction**

- Táº¥t cáº£ operations thÃ nh cÃ´ng hoáº·c táº¥t cáº£ fail
- KhÃ´ng cÃ³ tráº¡ng thÃ¡i inconsistent

### 2. **Performance**

- Ãt round-trips tá»›i database
- Prisma optimize queries tá»± Ä‘á»™ng

### 3. **Code Cleaner**

- KhÃ´ng cáº§n quáº£n lÃ½ foreign keys manually
- Ãt boilerplate code

### 4. **Type Safety**

- TypeScript type checking cho nested data
- Catch errors at compile time

---

## ğŸ” CÃ¡ch Verify Implementation

### 1. Kiá»ƒm tra Database

```sql
-- Sau khi táº¡o order, check xem cÃ³ ProductSKUSnapshot khÃ´ng
SELECT
  o.id as order_id,
  o.status,
  p.id as snapshot_id,
  p.productName,
  p.skuPrice,
  p.quantity
FROM "Order" o
LEFT JOIN "ProductSKUSnapshot" p ON o.id = p."orderId"
WHERE o.id = [order_id_vá»«a_táº¡o];
```

### 2. Add Logging Ä‘á»ƒ Debug

```typescript
const result = await tx.order.create({
  data: {
    // ... order data
    items: { create: itemsData },
  },
  include: {
    items: true, // âœ… Include Ä‘á»ƒ xem káº¿t quáº£
  },
})

console.log('Created order with items:', result.items.length)
```

---

## ğŸ“ Kiáº¿n Thá»©c RÃºt Ra

### 1. **Prisma Nested Writes Ráº¥t Máº¡nh**

- Cho phÃ©p táº¡o complex data structures trong má»™t láº§n
- Tá»± Ä‘á»™ng handle relationships

### 2. **KhÃ´ng Pháº£i LÃºc NÃ o CÅ©ng Cáº§n Explicit Creates**

- Relation fields cÃ³ thá»ƒ Ä‘Æ°á»£c populate thÃ´ng qua nested operations
- Prisma handle foreign key constraints tá»± Ä‘á»™ng

### 3. **Schema Design Quan Trá»ng**

- Thiáº¿t káº¿ relations Ä‘Ãºng trong schema
- Code logic sáº½ follow naturally

---

## ğŸ“š TÃ i Liá»‡u Tham Kháº£o

1. **Prisma Nested Writes**: https://www.prisma.io/docs/orm/prisma-client/queries/relation-queries#nested-writes
2. **Create a related record**: https://www.prisma.io/docs/orm/prisma-client/queries/relation-queries#create-a-related-record
3. **Create multiple records and multiple related records**: https://www.prisma.io/docs/orm/prisma-client/queries/relation-queries#create-multiple-records-and-multiple-related-records

---

## âœ… Káº¿t Luáº­n Cuá»‘i CÃ¹ng

**Giáº£ng viÃªn cá»§a báº¡n hoÃ n toÃ n Ä‘Ãºng!**

Dá»± Ã¡n Ä‘Ã£ implement ProductSKUSnapshot pattern má»™t cÃ¡ch elegant thÃ´ng qua:

- âœ… **Nested writes** trong Prisma
- âœ… **Single transaction** Ä‘áº£m báº£o data consistency
- âœ… **Clean code** without manual foreign key management
- âœ… **Type safety** vá»›i TypeScript

ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ tuyá»‡t vá»i vá» cÃ¡ch sá»­ dá»¥ng Prisma ORM hiá»‡u quáº£ Ä‘á»ƒ handle complex business logic! ğŸš€

---

**Lá»i xin lá»—i**: TÃ´i Ä‘Ã£ phÃ¢n tÃ­ch sai trong láº§n Ä‘áº§u vÃ¬ khÃ´ng nháº­n ra nested writes pattern. Cáº£m Æ¡n báº¡n vÃ  giáº£ng viÃªn Ä‘Ã£ chá»‰ ra Ä‘iá»u nÃ y! ğŸ™
