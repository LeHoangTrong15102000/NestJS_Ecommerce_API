# BÃ¡o CÃ¡o PhÃ¢n TÃ­ch ProductSKUSnapshot trong Dá»± Ãn

## ğŸ” TÃ³m Táº¯t PhÃ¡t Hiá»‡n Quan Trá»ng

**Káº¾T LUáº¬N: HIá»†N Táº I KHÃ”NG CÃ“ LOGIC Táº O `ProductSKUSnapshot` KHI Táº O ORDER**

Dá»± Ã¡n cá»§a báº¡n hiá»‡n táº¡i **KHÃ”NG** táº¡o ra `ProductSKUSnapshot` khi táº¡o order trong code thá»±c táº¿ cá»§a API. Thay vÃ o Ä‘Ã³, dá»± Ã¡n Ä‘ang táº¡o trá»±c tiáº¿p cÃ¡c `OrderItem` thÃ´ng qua nested create trong Prisma.

---

## ğŸ“‹ Chi Tiáº¿t PhÃ¢n TÃ­ch

### 1. Quy TrÃ¬nh Táº¡o Order Hiá»‡n Táº¡i (trong `order.repo.ts`)

**File: `src/routes/order/order.repo.ts` - Lines 159-179**

```typescript
items: {
  create: item.cartItemIds.map((cartItemId) => {
    const cartItem = cartItemMap.get(cartItemId)!
    return {
      productName: cartItem.sku.product.name,        // âŒ Táº¡o trá»±c tiáº¿p OrderItem
      skuPrice: cartItem.sku.price,                  // âŒ KhÃ´ng pháº£i ProductSKUSnapshot
      image: cartItem.sku.image,
      skuId: cartItem.sku.id,
      skuValue: cartItem.sku.value,
      quantity: cartItem.quantity,
      productId: cartItem.sku.product.id,
      productTranslations: cartItem.sku.product.productTranslations.map((translation) => {
        return {
          id: translation.id,
          name: translation.name,
          description: translation.description,
          languageId: translation.languageId,
        }
      }),
    }
  }),
},
```

### 2. Váº¥n Äá» Vá»›i CÃ¡ch Tiáº¿p Cáº­n Hiá»‡n Táº¡i

#### âŒ **KhÃ´ng TuÃ¢n Theo Snapshot Pattern**

- Dá»¯ liá»‡u order item Ä‘Æ°á»£c lÆ°u trá»±c tiáº¿p vÃ o báº£ng `Order.items` (JSON field)
- KhÃ´ng cÃ³ báº£ng `ProductSKUSnapshot` riÃªng biá»‡t Ä‘á»ƒ lÆ°u trá»¯ snapshot
- Vi pháº¡m nguyÃªn táº¯c immutable data cho historical records

#### âŒ **Thiáº¿u TÃ­nh Báº£o ToÃ n Dá»¯ Liá»‡u**

- Náº¿u SKU hoáº·c Product bá»‹ thay Ä‘á»•i giÃ¡/thÃ´ng tin sau khi order Ä‘Æ°á»£c táº¡o
- KhÃ´ng cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ trace láº¡i thÃ´ng tin chÃ­nh xÃ¡c táº¡i thá»i Ä‘iá»ƒm Ä‘áº·t hÃ ng
- Risk cao cho viá»‡c audit vÃ  compliance

### 3. NÆ¡i CÃ³ Logic Táº¡o ProductSKUSnapshot

#### âœ… **Trong Script Khá»Ÿi Táº¡o Dá»¯ Liá»‡u**

**File: `initialScript/add-cart-order-data.ts` - Lines 553-574**

```typescript
await prisma.productSKUSnapshot.create({
  data: {
    productId: product?.id || null,
    productName: product?.name || 'Unknown Product',
    productTranslations: productTranslation ? [...] : [],
    skuPrice: sku?.price || 0,
    image: sku?.image || pickRandom(SAMPLE_IMAGE_URLS),
    skuValue: sku?.value || 'Unknown',
    skuId: sku?.id || null,
    orderId: order.id,                    // âœ… LiÃªn káº¿t vá»›i order
    quantity: cartItem.quantity,
  },
})
```

#### âœ… **Trong Stored Procedures (TÃ i Liá»‡u)**

**File: `docs/ZZ_27_STORED_PROCEDURES_COMPLETE_GUIDE.md`**

CÃ³ logic táº¡o ProductSKUSnapshot trong stored procedure nhÆ°ng khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng trong API thá»±c táº¿.

---

## ğŸš¨ Váº¥n Äá» Kiáº¿n TrÃºc NghiÃªm Trá»ng

### 1. **Inconsistency Between Schema vÃ  Implementation**

- Schema Prisma Ä‘á»‹nh nghÄ©a model `ProductSKUSnapshot`
- NhÆ°ng API khÃ´ng sá»­ dá»¥ng model nÃ y
- Chá»‰ cÃ³ script seed data vÃ  documentation sá»­ dá»¥ng

### 2. **Missing Snapshot Logic**

```typescript
// âŒ THIáº¾U: Logic táº¡o ProductSKUSnapshot khi táº¡o order
const productSnapshot = await tx.productSKUSnapshot.create({
  data: {
    orderId: order.id,
    skuId: cartItem.sku.id,
    productId: cartItem.sku.product.id,
    productName: cartItem.sku.product.name,
    skuPrice: cartItem.sku.price,
    image: cartItem.sku.image,
    skuValue: cartItem.sku.value,
    quantity: cartItem.quantity,
    productTranslations: cartItem.sku.product.productTranslations,
  },
})
```

### 3. **Model Schema Confusion**

- `Order.items` lÃ  JSON field chá»©a dá»¯ liá»‡u tÆ°Æ¡ng tá»± ProductSKUSnapshot
- CÃ³ váº» nhÆ° dá»± Ã¡n Ä‘ang á»Ÿ giai Ä‘oáº¡n transition tá»« JSON approach sang normalized approach

---

## ğŸ’¡ Khuyáº¿n Nghá»‹ Giáº£i PhÃ¡p

### Option 1: **Implement ProductSKUSnapshot Pattern (Khuyáº¿n nghá»‹)**

```typescript
// Trong order.repo.ts - method create()
const [paymentId, orders] = await this.prismaService.$transaction(async (tx) => {
  const payment = await tx.payment.create({
    data: { status: PaymentStatus.PENDING },
  })

  const orders$ = Promise.all(
    body.map(async (item) => {
      const order = await tx.order.create({
        data: {
          userId,
          status: OrderStatus.PENDING_PAYMENT,
          receiver: item.receiver,
          createdById: userId,
          shopId: item.shopId,
          paymentId: payment.id,
        },
      })

      // âœ… Táº O ProductSKUSnapshot cho tá»«ng item
      const snapshots$ = item.cartItemIds.map((cartItemId) => {
        const cartItem = cartItemMap.get(cartItemId)!
        return tx.productSKUSnapshot.create({
          data: {
            orderId: order.id,
            skuId: cartItem.sku.id,
            productId: cartItem.sku.product.id,
            productName: cartItem.sku.product.name,
            skuPrice: cartItem.sku.price,
            image: cartItem.sku.image,
            skuValue: cartItem.sku.value,
            quantity: cartItem.quantity,
            productTranslations: cartItem.sku.product.productTranslations,
          },
        })
      })

      await Promise.all(snapshots$)
      return order
    }),
  )

  // ... rest cá»§a transaction
})
```

### Option 2: **Keep JSON Approach nhÆ°ng Improve Structure**

Náº¿u muá»‘n giá»¯ approach hiá»‡n táº¡i, cáº§n standardize JSON structure vÃ  add validation.

---

## ğŸ¯ Káº¿ Hoáº¡ch Thá»±c Hiá»‡n

### Phase 1: **Audit Current Data**

1. Check xem cÃ³ data nÃ o trong `ProductSKUSnapshot` table chÆ°a
2. Analyze performance impact cá»§a JSON vs normalized approach

### Phase 2: **Implement Snapshot Logic**

1. Modify `order.repo.ts` Ä‘á»ƒ táº¡o ProductSKUSnapshot
2. Update related queries Ä‘á»ƒ sá»­ dá»¥ng snapshot data
3. Add migration script Ä‘á»ƒ convert existing data

### Phase 3: **Testing & Validation**

1. Test transaction integrity
2. Verify data consistency
3. Performance benchmarking

---

## ğŸ“Š So SÃ¡nh Approaches

| Aspect                | Current (JSON)  | ProductSKUSnapshot (Recommended) |
| --------------------- | --------------- | -------------------------------- |
| **Data Integrity**    | âŒ Mutable      | âœ… Immutable                     |
| **Query Performance** | âŒ JSON parsing | âœ… Indexed queries               |
| **Audit Trail**       | âŒ Limited      | âœ… Complete                      |
| **Scalability**       | âŒ Poor         | âœ… Excellent                     |
| **Compliance**        | âŒ Risk         | âœ… Safe                          |

---

## ğŸ”— Files LiÃªn Quan

1. **Main Implementation**: `src/routes/order/order.repo.ts`
2. **Schema Definition**: `prisma/schema.prisma` (lines 405-421)
3. **Model Definitions**: `src/routes/order/order.model.ts`
4. **Example Implementation**: `initialScript/add-cart-order-data.ts`
5. **Documentation**: `docs/ZZ_62_SNAPSHOT_PATTERN_DEEP_DIVE.md`

---

## âœ… Káº¿t Luáº­n

Dá»± Ã¡n cá»§a báº¡n **HIá»†N Táº I KHÃ”NG** implement ProductSKUSnapshot pattern trong production code. ÄÃ¢y lÃ  má»™t gap nghiÃªm trá»ng cáº§n Ä‘Æ°á»£c address Ä‘á»ƒ Ä‘áº£m báº£o data integrity vÃ  audit trail cho cÃ¡c transactions thÆ°Æ¡ng máº¡i Ä‘iá»‡n tá»­.

**Action Items:**

1. â— **Urgent**: Implement ProductSKUSnapshot creation trong order flow
2. ğŸ“ **Important**: Update data retrieval logic Ä‘á»ƒ sá»­ dá»¥ng snapshot
3. ğŸ”„ **Nice-to-have**: Migration script cho existing data
