# Báo Cáo Phân Tích ProductSKUSnapshot trong Dự Án

## 🔍 Tóm Tắt Phát Hiện Quan Trọng

**KẾT LUẬN: HIỆN TẠI KHÔNG CÓ LOGIC TẠO `ProductSKUSnapshot` KHI TẠO ORDER**

Dự án của bạn hiện tại **KHÔNG** tạo ra `ProductSKUSnapshot` khi tạo order trong code thực tế của API. Thay vào đó, dự án đang tạo trực tiếp các `OrderItem` thông qua nested create trong Prisma.

---

## 📋 Chi Tiết Phân Tích

### 1. Quy Trình Tạo Order Hiện Tại (trong `order.repo.ts`)

**File: `src/routes/order/order.repo.ts` - Lines 159-179**

```typescript
items: {
  create: item.cartItemIds.map((cartItemId) => {
    const cartItem = cartItemMap.get(cartItemId)!
    return {
      productName: cartItem.sku.product.name,        // ❌ Tạo trực tiếp OrderItem
      skuPrice: cartItem.sku.price,                  // ❌ Không phải ProductSKUSnapshot
      image: cartItem.sku.image,
      skuId: cartItem.sku.id,
      skuValue: cartItem.sku.value,
      quantity: cartItem.quantity,
      productId: cartItem.sku.product.id,
      productTranslations: cartItem.sku.product.productTranslations.map((translation) => {
        return {
          id: translation.id,
          name: translation.name,
          description: translation.description,
          languageId: translation.languageId,
        }
      }),
    }
  }),
},
```

### 2. Vấn Đề Với Cách Tiếp Cận Hiện Tại

#### ❌ **Không Tuân Theo Snapshot Pattern**

- Dữ liệu order item được lưu trực tiếp vào bảng `Order.items` (JSON field)
- Không có bảng `ProductSKUSnapshot` riêng biệt để lưu trữ snapshot
- Vi phạm nguyên tắc immutable data cho historical records

#### ❌ **Thiếu Tính Bảo Toàn Dữ Liệu**

- Nếu SKU hoặc Product bị thay đổi giá/thông tin sau khi order được tạo
- Không có cách nào để trace lại thông tin chính xác tại thời điểm đặt hàng
- Risk cao cho việc audit và compliance

### 3. Nơi Có Logic Tạo ProductSKUSnapshot

#### ✅ **Trong Script Khởi Tạo Dữ Liệu**

**File: `initialScript/add-cart-order-data.ts` - Lines 553-574**

```typescript
await prisma.productSKUSnapshot.create({
  data: {
    productId: product?.id || null,
    productName: product?.name || 'Unknown Product',
    productTranslations: productTranslation ? [...] : [],
    skuPrice: sku?.price || 0,
    image: sku?.image || pickRandom(SAMPLE_IMAGE_URLS),
    skuValue: sku?.value || 'Unknown',
    skuId: sku?.id || null,
    orderId: order.id,                    // ✅ Liên kết với order
    quantity: cartItem.quantity,
  },
})
```

#### ✅ **Trong Stored Procedures (Tài Liệu)**

**File: `docs/ZZ_27_STORED_PROCEDURES_COMPLETE_GUIDE.md`**

Có logic tạo ProductSKUSnapshot trong stored procedure nhưng không được sử dụng trong API thực tế.

---

## 🚨 Vấn Đề Kiến Trúc Nghiêm Trọng

### 1. **Inconsistency Between Schema và Implementation**

- Schema Prisma định nghĩa model `ProductSKUSnapshot`
- Nhưng API không sử dụng model này
- Chỉ có script seed data và documentation sử dụng

### 2. **Missing Snapshot Logic**

```typescript
// ❌ THIẾU: Logic tạo ProductSKUSnapshot khi tạo order
const productSnapshot = await tx.productSKUSnapshot.create({
  data: {
    orderId: order.id,
    skuId: cartItem.sku.id,
    productId: cartItem.sku.product.id,
    productName: cartItem.sku.product.name,
    skuPrice: cartItem.sku.price,
    image: cartItem.sku.image,
    skuValue: cartItem.sku.value,
    quantity: cartItem.quantity,
    productTranslations: cartItem.sku.product.productTranslations,
  },
})
```

### 3. **Model Schema Confusion**

- `Order.items` là JSON field chứa dữ liệu tương tự ProductSKUSnapshot
- Có vẻ như dự án đang ở giai đoạn transition từ JSON approach sang normalized approach

---

## 💡 Khuyến Nghị Giải Pháp

### Option 1: **Implement ProductSKUSnapshot Pattern (Khuyến nghị)**

```typescript
// Trong order.repo.ts - method create()
const [paymentId, orders] = await this.prismaService.$transaction(async (tx) => {
  const payment = await tx.payment.create({
    data: { status: PaymentStatus.PENDING },
  })

  const orders$ = Promise.all(
    body.map(async (item) => {
      const order = await tx.order.create({
        data: {
          userId,
          status: OrderStatus.PENDING_PAYMENT,
          receiver: item.receiver,
          createdById: userId,
          shopId: item.shopId,
          paymentId: payment.id,
        },
      })

      // ✅ TẠO ProductSKUSnapshot cho từng item
      const snapshots$ = item.cartItemIds.map((cartItemId) => {
        const cartItem = cartItemMap.get(cartItemId)!
        return tx.productSKUSnapshot.create({
          data: {
            orderId: order.id,
            skuId: cartItem.sku.id,
            productId: cartItem.sku.product.id,
            productName: cartItem.sku.product.name,
            skuPrice: cartItem.sku.price,
            image: cartItem.sku.image,
            skuValue: cartItem.sku.value,
            quantity: cartItem.quantity,
            productTranslations: cartItem.sku.product.productTranslations,
          },
        })
      })

      await Promise.all(snapshots$)
      return order
    }),
  )

  // ... rest của transaction
})
```

### Option 2: **Keep JSON Approach nhưng Improve Structure**

Nếu muốn giữ approach hiện tại, cần standardize JSON structure và add validation.

---

## 🎯 Kế Hoạch Thực Hiện

### Phase 1: **Audit Current Data**

1. Check xem có data nào trong `ProductSKUSnapshot` table chưa
2. Analyze performance impact của JSON vs normalized approach

### Phase 2: **Implement Snapshot Logic**

1. Modify `order.repo.ts` để tạo ProductSKUSnapshot
2. Update related queries để sử dụng snapshot data
3. Add migration script để convert existing data

### Phase 3: **Testing & Validation**

1. Test transaction integrity
2. Verify data consistency
3. Performance benchmarking

---

## 📊 So Sánh Approaches

| Aspect                | Current (JSON)  | ProductSKUSnapshot (Recommended) |
| --------------------- | --------------- | -------------------------------- |
| **Data Integrity**    | ❌ Mutable      | ✅ Immutable                     |
| **Query Performance** | ❌ JSON parsing | ✅ Indexed queries               |
| **Audit Trail**       | ❌ Limited      | ✅ Complete                      |
| **Scalability**       | ❌ Poor         | ✅ Excellent                     |
| **Compliance**        | ❌ Risk         | ✅ Safe                          |

---

## 🔗 Files Liên Quan

1. **Main Implementation**: `src/routes/order/order.repo.ts`
2. **Schema Definition**: `prisma/schema.prisma` (lines 405-421)
3. **Model Definitions**: `src/routes/order/order.model.ts`
4. **Example Implementation**: `initialScript/add-cart-order-data.ts`
5. **Documentation**: `docs/ZZ_62_SNAPSHOT_PATTERN_DEEP_DIVE.md`

---

## ✅ Kết Luận

Dự án của bạn **HIỆN TẠI KHÔNG** implement ProductSKUSnapshot pattern trong production code. Đây là một gap nghiêm trọng cần được address để đảm bảo data integrity và audit trail cho các transactions thương mại điện tử.

**Action Items:**

1. ❗ **Urgent**: Implement ProductSKUSnapshot creation trong order flow
2. 📝 **Important**: Update data retrieval logic để sử dụng snapshot
3. 🔄 **Nice-to-have**: Migration script cho existing data
