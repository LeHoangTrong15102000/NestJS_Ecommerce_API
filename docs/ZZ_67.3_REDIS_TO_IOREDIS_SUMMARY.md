# ğŸ“Š TÃ“M Táº®T CHUYá»‚N Äá»”I REDIS SANG IOREDIS

## ğŸ¯ Má»¤C TIÃŠU

Chuyá»ƒn Ä‘á»•i toÃ n bá»™ code sá»­ dá»¥ng thÆ° viá»‡n `redis` (node-redis) sang `ioredis` Ä‘á»ƒ:
- TÄƒng performance
- Cáº£i thiá»‡n TypeScript support
- Tá»‘i Æ°u auto-reconnect vÃ  error handling
- TÆ°Æ¡ng thÃ­ch tá»‘t hÆ¡n vá»›i NestJS ecosystem

---

## ğŸ“‹ DANH SÃCH FILES Cáº¦N THAY Äá»”I

### âœ… Files Cáº§n Sá»­a (2 files)

1. **`src/websockets/websocket.adapter.ts`**
   - Thay Ä‘á»•i: Import vÃ  khá»Ÿi táº¡o Redis clients
   - Äá»™ phá»©c táº¡p: â­â­â˜†â˜†â˜†

2. **`src/websockets/services/chat-redis.service.ts`**
   - Thay Ä‘á»•i: Import, type, constructor, vÃ  táº¥t cáº£ methods sá»­ dá»¥ng `setEx`
   - Äá»™ phá»©c táº¡p: â­â­â­â˜†â˜†

### âŒ Files KHÃ”NG Cáº§n Sá»­a

- `src/app.module.ts` - Sá»­ dá»¥ng `@keyv/redis` (khÃ´ng áº£nh hÆ°á»Ÿng)
- `src/main.ts` - Chá»‰ gá»i method, khÃ´ng cáº§n sá»­a
- Táº¥t cáº£ files khÃ¡c - KhÃ´ng sá»­ dá»¥ng Redis trá»±c tiáº¿p

---

## ğŸ”„ THAY Äá»”I CHI TIáº¾T

### File 1: `src/websockets/websocket.adapter.ts`

#### Thay Ä‘á»•i 1: Import

```diff
- import { createClient } from 'redis'
+ import Redis from 'ioredis'
```

#### Thay Ä‘á»•i 2: Method `connectToRedis()`

```diff
  async connectToRedis(): Promise<void> {
-   const pubClient = createClient({ url: envConfig.REDIS_URL })
+   const pubClient = new Redis(envConfig.REDIS_URL, {
+     retryStrategy: (times) => Math.min(times * 50, 2000),
+     maxRetriesPerRequest: 3,
+     enableOfflineQueue: true,
+   })
    
    const subClient = pubClient.duplicate()
    
-   await Promise.all([pubClient.connect(), subClient.connect()])
+   // Äá»£i ready events (optional)
+   await Promise.all([
+     new Promise<void>((resolve) => {
+       if (pubClient.status === 'ready') resolve()
+       else pubClient.once('ready', () => resolve())
+     }),
+     new Promise<void>((resolve) => {
+       if (subClient.status === 'ready') resolve()
+       else subClient.once('ready', () => resolve())
+     }),
+   ])
    
    this.adapterConstructor = createAdapter(pubClient, subClient)
  }
```

**Tá»•ng sá»‘ thay Ä‘á»•i:** 2 chá»—

---

### File 2: `src/websockets/services/chat-redis.service.ts`

#### Thay Ä‘á»•i 1: Import

```diff
- import { createClient, RedisClientType } from 'redis'
+ import Redis from 'ioredis'
```

#### Thay Ä‘á»•i 2: Type declaration

```diff
- private readonly redis: RedisClientType
+ private readonly redis: Redis
```

#### Thay Ä‘á»•i 3: Constructor

```diff
  constructor() {
-   this.redis = createClient({ url: envConfig.REDIS_URL })
+   this.redis = new Redis(envConfig.REDIS_URL, {
+     retryStrategy: (times) => {
+       const delay = Math.min(times * 50, 2000)
+       return delay
+     },
+     maxRetriesPerRequest: 3,
+     enableOfflineQueue: true,
+   })
    
    this.redis.on('connect', () => {
      this.logger.log('Connected to Redis for chat cache')
    })
    
+   this.redis.on('ready', () => {
+     this.logger.log('Redis is ready for chat cache')
+   })
    
    this.redis.on('error', (error) => {
      this.logger.error('Redis connection error:', error)
    })
    
-   // Connect to Redis
-   this.redis.connect().catch((error) => {
-     this.logger.error('Failed to connect to Redis:', error)
-   })
+   this.redis.on('close', () => {
+     this.logger.warn('Redis connection closed')
+   })
+   
+   this.redis.on('reconnecting', () => {
+     this.logger.log('Reconnecting to Redis...')
+   })
  }
```

#### Thay Ä‘á»•i 4: Táº¥t cáº£ `setEx` â†’ `setex` (6 chá»—)

```diff
  // Line ~55 - addOnlineUser()
- await this.redis.setEx(userKey, 3600, JSON.stringify(currentSockets))
+ await this.redis.setex(userKey, 3600, JSON.stringify(currentSockets))

  // Line ~81 - removeOnlineUser()
- await this.redis.setEx(userKey, 3600, JSON.stringify(updatedSockets))
+ await this.redis.setex(userKey, 3600, JSON.stringify(updatedSockets))

  // Line ~146 - setSocketUser()
- await this.redis.setEx(socketKey, 3600, JSON.stringify(userInfo))
+ await this.redis.setex(socketKey, 3600, JSON.stringify(userInfo))

  // Line ~197 - setUserTyping()
- await this.redis.setEx(typingKey, expiresInSeconds, JSON.stringify(currentTyping))
+ await this.redis.setex(typingKey, expiresInSeconds, JSON.stringify(currentTyping))

  // Line ~222 - removeUserTyping()
- await this.redis.setEx(typingKey, 10, JSON.stringify(updatedTyping))
+ await this.redis.setex(typingKey, 10, JSON.stringify(updatedTyping))

  // Line ~275 - cacheUserConversations()
- await this.redis.setEx(userConversationsKey, 300, JSON.stringify(conversationIds))
+ await this.redis.setex(userConversationsKey, 300, JSON.stringify(conversationIds))
```

#### Thay Ä‘á»•i 5: Method `disconnect()`

```diff
  async disconnect(): Promise<void> {
    try {
-     await this.redis.disconnect()
+     await this.redis.quit()
      this.logger.log('Disconnected from Redis')
    } catch (error) {
      this.logger.error('Error disconnecting from Redis:', error)
    }
  }
```

**Tá»•ng sá»‘ thay Ä‘á»•i:** 11 chá»— (1 import + 1 type + 1 constructor + 6 setEx + 1 disconnect + 1 event listener)

---

## ğŸ“Š THá»NG KÃŠ THAY Äá»”I

| File | Sá»‘ dÃ²ng thay Ä‘á»•i | Äá»™ phá»©c táº¡p | Thá»i gian Æ°á»›c tÃ­nh |
|------|------------------|-------------|-------------------|
| `websocket.adapter.ts` | ~15 dÃ²ng | â­â­â˜†â˜†â˜† | 10 phÃºt |
| `chat-redis.service.ts` | ~25 dÃ²ng | â­â­â­â˜†â˜† | 20 phÃºt |
| **Tá»”NG** | **~40 dÃ²ng** | **â­â­â˜†â˜†â˜†** | **30 phÃºt** |

---

## ğŸ¯ CHECKLIST THá»°C HIá»†N

### Giai Ä‘oáº¡n 1: Chuáº©n bá»‹ (5 phÃºt)
- [ ] Äá»c tÃ i liá»‡u `REDIS_TO_IOREDIS_MIGRATION_ANALYSIS.md`
- [ ] Äá»c tÃ i liá»‡u `REDIS_TO_IOREDIS_IMPLEMENTATION_GUIDE.md`
- [ ] Backup code (git commit)
- [ ] Kiá»ƒm tra `ioredis` Ä‘Ã£ cÃ i Ä‘áº·t

### Giai Ä‘oáº¡n 2: Sá»­a File 1 (10 phÃºt)
- [ ] Má»Ÿ `src/websockets/websocket.adapter.ts`
- [ ] Thay Ä‘á»•i import: `redis` â†’ `ioredis`
- [ ] Cáº­p nháº­t method `connectToRedis()`
- [ ] Save file

### Giai Ä‘oáº¡n 3: Sá»­a File 2 (20 phÃºt)
- [ ] Má»Ÿ `src/websockets/services/chat-redis.service.ts`
- [ ] Thay Ä‘á»•i import
- [ ] Thay Ä‘á»•i type declaration
- [ ] Cáº­p nháº­t constructor
- [ ] Find & Replace: `setEx` â†’ `setex` (6 chá»—)
- [ ] Cáº­p nháº­t method `disconnect()`
- [ ] Save file

### Giai Ä‘oáº¡n 4: Testing (15 phÃºt)
- [ ] Build project: `pnpm run build`
- [ ] Run tests: `pnpm run test:unit`
- [ ] Start dev server: `pnpm run start:dev`
- [ ] Kiá»ƒm tra logs (khÃ´ng cÃ³ errors)
- [ ] Test WebSocket connection
- [ ] Test chat features

### Giai Ä‘oáº¡n 5: Cleanup (5 phÃºt)
- [ ] Review code changes
- [ ] Commit vá»›i message rÃµ rÃ ng
- [ ] (Optional) Remove package `redis` náº¿u khÃ´ng cÃ²n dependency

**Tá»•ng thá»i gian:** ~55 phÃºt

---

## ğŸ” ÄIá»‚M Cáº¦N LÆ¯U Ã

### 1. API Differences

| Chá»©c nÄƒng | redis | ioredis | LÆ°u Ã½ |
|-----------|-------|---------|-------|
| Constructor | `createClient()` | `new Redis()` | âš ï¸ KhÃ¡c nhau |
| Connect | `connect()` | KhÃ´ng cáº§n | âš ï¸ Auto-connect |
| Set with TTL | `setEx()` | `setex()` | âš ï¸ Lowercase |
| Disconnect | `disconnect()` | `quit()` | âš ï¸ KhÃ¡c nhau |
| Get | `get()` | `get()` | âœ… Giá»‘ng nhau |
| Delete | `del()` | `del()` | âœ… Giá»‘ng nhau |
| Exists | `exists()` | `exists()` | âœ… Giá»‘ng nhau |
| Keys | `keys()` | `keys()` | âœ… Giá»‘ng nhau |
| Ping | `ping()` | `ping()` | âœ… Giá»‘ng nhau |

### 2. Event Listeners

**redis:**
- `connect` - Khi káº¿t ná»‘i
- `error` - Khi cÃ³ lá»—i

**ioredis (nhiá»u hÆ¡n):**
- `connect` - Khi káº¿t ná»‘i
- `ready` - Khi sáºµn sÃ ng nháº­n commands
- `error` - Khi cÃ³ lá»—i
- `close` - Khi Ä‘Ã³ng káº¿t ná»‘i
- `reconnecting` - Khi Ä‘ang reconnect
- `end` - Khi káº¿t thÃºc

### 3. Configuration Options

**ioredis cÃ³ nhiá»u options hÆ¡n:**
- `retryStrategy` - Chiáº¿n lÆ°á»£c retry
- `maxRetriesPerRequest` - Sá»‘ láº§n retry tá»‘i Ä‘a
- `enableOfflineQueue` - Queue commands khi offline
- `connectTimeout` - Timeout khi connect
- `keepAlive` - Keep connection alive
- `reconnectOnError` - Reconnect khi cÃ³ error cá»¥ thá»ƒ

---

## âœ… Lá»¢I ÃCH SAU KHI MIGRATION

### 1. Performance
- âš¡ Faster command execution
- âš¡ Better pipeline support
- âš¡ Optimized for high throughput

### 2. Developer Experience
- ğŸ“ Better TypeScript support
- ğŸ“ More comprehensive documentation
- ğŸ“ Active community

### 3. Reliability
- ğŸ”„ Auto-reconnect tá»‘t hÆ¡n
- ğŸ”„ Better error handling
- ğŸ”„ Offline queue support

### 4. Features
- âœ¨ Full Cluster support
- âœ¨ Full Sentinel support
- âœ¨ Better Lua scripting
- âœ¨ Stream support

---

## ğŸš¨ Rá»¦I RO VÃ€ CÃCH PHÃ’NG TRÃNH

### Rá»§i ro 1: Breaking Changes
**PhÃ²ng trÃ¡nh:**
- Äá»c ká»¹ migration guide
- Test ká»¹ trÆ°á»›c khi deploy
- CÃ³ backup code

### Rá»§i ro 2: Performance Regression
**PhÃ²ng trÃ¡nh:**
- Monitor performance sau migration
- So sÃ¡nh metrics trÆ°á»›c vÃ  sau
- Load testing

### Rá»§i ro 3: Connection Issues
**PhÃ²ng trÃ¡nh:**
- Configure retry strategy Ä‘Ãºng
- Monitor connection logs
- Test reconnection scenarios

---

## ğŸ“š TÃ€I LIá»†U LIÃŠN QUAN

1. **REDIS_TO_IOREDIS_MIGRATION_ANALYSIS.md** - PhÃ¢n tÃ­ch chi tiáº¿t
2. **REDIS_TO_IOREDIS_IMPLEMENTATION_GUIDE.md** - HÆ°á»›ng dáº«n tá»«ng bÆ°á»›c
3. **REDIS_TO_IOREDIS_SUMMARY.md** - TÃ i liá»‡u nÃ y

---

## ğŸ“ Káº¾T LUáº¬N

Migration tá»« `redis` sang `ioredis` lÃ  má»™t thay Ä‘á»•i:
- âœ… **ÄÆ¡n giáº£n** - Chá»‰ 2 files, ~40 dÃ²ng code
- âœ… **An toÃ n** - API tÆ°Æ¡ng tá»±, Ã­t breaking changes
- âœ… **CÃ³ lá»£i** - Performance tá»‘t hÆ¡n, features nhiá»u hÆ¡n
- âœ… **Nhanh** - HoÃ n thÃ nh trong ~1 giá»

**Khuyáº¿n nghá»‹:** NÃªn thá»±c hiá»‡n migration nÃ y Ä‘á»ƒ táº­n dá»¥ng cÃ¡c Æ°u Ä‘iá»ƒm cá»§a `ioredis`.

---

**NgÆ°á»i thá»±c hiá»‡n:** Developer
**Thá»i gian:** ~1 giá»
**Äá»™ Æ°u tiÃªn:** Medium
**Äá»™ khÃ³:** â­â­â˜†â˜†â˜† (Dá»… - Trung bÃ¬nh)

