# ğŸš€ HÆ¯á»šNG DáºªN THá»°C HIá»†N CHUYá»‚N Äá»”I REDIS SANG IOREDIS

## ğŸ“ Tá»”NG QUAN

TÃ i liá»‡u nÃ y cung cáº¥p hÆ°á»›ng dáº«n tá»«ng bÆ°á»›c Ä‘á»ƒ chuyá»ƒn Ä‘á»•i tá»« `redis` sang `ioredis` trong dá»± Ã¡n NestJS Ecommerce API.

---

## âœ… CHECKLIST TRÆ¯á»šC KHI Báº®T Äáº¦U

- [ ] Backup code hiá»‡n táº¡i (git commit)
- [ ] Äá»c ká»¹ file `REDIS_TO_IOREDIS_MIGRATION_ANALYSIS.md`
- [ ] Kiá»ƒm tra version `ioredis` Ä‘Ã£ cÃ i Ä‘áº·t: `^5.7.0`
- [ ] Kiá»ƒm tra cÃ¡c dependencies phá»¥ thuá»™c vÃ o `redis`
- [ ] Chuáº©n bá»‹ mÃ´i trÆ°á»ng test

---

## ğŸ”§ BÆ¯á»šC 1: KIá»‚M TRA DEPENDENCIES

### 1.1. Kiá»ƒm tra package.json

```bash
# Xem cÃ¡c package Ä‘ang sá»­ dá»¥ng redis
pnpm list redis
pnpm list ioredis
```

### 1.2. Kiá»ƒm tra dependencies phá»¥ thuá»™c

```json
{
  "@keyv/redis": "^5.1.1",           // Sá»­ dá»¥ng @redis/client (tá»« package redis)
  "@socket.io/redis-adapter": "^8.3.0", // Há»— trá»£ cáº£ redis vÃ  ioredis âœ…
  "@nestjs/bullmq": "^11.0.3",       // Sá»­ dá»¥ng ioredis internally âœ…
  "bullmq": "^5.58.0"                // Sá»­ dá»¥ng ioredis âœ…
}
```

**Káº¿t luáº­n:**
- `@socket.io/redis-adapter` há»— trá»£ cáº£ 2 â†’ An toÃ n Ä‘á»ƒ migrate
- `BullMQ` Ä‘Ã£ dÃ¹ng `ioredis` â†’ KhÃ´ng áº£nh hÆ°á»Ÿng
- `@keyv/redis` sá»­ dá»¥ng `@redis/client` â†’ Giá»¯ nguyÃªn, khÃ´ng áº£nh hÆ°á»Ÿng

---

## ğŸ”§ BÆ¯á»šC 2: Cáº¬P NHáº¬T FILE `websocket.adapter.ts`

### 2.1. Má»Ÿ file

```bash
code src/websockets/websocket.adapter.ts
```

### 2.2. Thay Ä‘á»•i import

```typescript
// âŒ XÃ“A
import { createClient } from 'redis'

// âœ… THÃŠM
import Redis from 'ioredis'
```

### 2.3. Cáº­p nháº­t method `connectToRedis()`

```typescript
async connectToRedis(): Promise<void> {
  // âœ… Táº¡o Redis clients vá»›i ioredis
  const pubClient = new Redis(envConfig.REDIS_URL, {
    retryStrategy: (times) => {
      const delay = Math.min(times * 50, 2000)
      return delay
    },
    maxRetriesPerRequest: 3,
    enableOfflineQueue: true,
  })

  const subClient = pubClient.duplicate()

  // âœ… Äá»£i ready events (optional nhÆ°ng recommended)
  await Promise.all([
    new Promise<void>((resolve) => {
      if (pubClient.status === 'ready') {
        resolve()
      } else {
        pubClient.once('ready', () => resolve())
      }
    }),
    new Promise<void>((resolve) => {
      if (subClient.status === 'ready') {
        resolve()
      } else {
        subClient.once('ready', () => resolve())
      }
    }),
  ])

  this.adapterConstructor = createAdapter(pubClient, subClient)
}
```

### 2.4. File hoÃ n chá»‰nh

```typescript
import { INestApplicationContext } from '@nestjs/common'
import { IoAdapter } from '@nestjs/platform-socket.io'
import { createAdapter } from '@socket.io/redis-adapter'
import Redis from 'ioredis'
import { ServerOptions, Server, Socket } from 'socket.io'
import envConfig from 'src/shared/config'
import { generateRoomUserId } from 'src/shared/helpers'
import { SharedWebsocketRepository } from 'src/shared/repositories/shared-websocket.repo'
import { TokenService } from 'src/shared/services/token.service'

export class WebsocketAdapter extends IoAdapter {
  private readonly sharedWebsocketRepository: SharedWebsocketRepository
  private readonly tokenService: TokenService
  private adapterConstructor: ReturnType<typeof createAdapter>
  
  constructor(app: INestApplicationContext) {
    super(app)
    this.sharedWebsocketRepository = app.get(SharedWebsocketRepository)
    this.tokenService = app.get(TokenService)
  }

  async connectToRedis(): Promise<void> {
    const pubClient = new Redis(envConfig.REDIS_URL, {
      retryStrategy: (times) => {
        const delay = Math.min(times * 50, 2000)
        return delay
      },
      maxRetriesPerRequest: 3,
      enableOfflineQueue: true,
    })

    const subClient = pubClient.duplicate()

    // Äá»£i ready events
    await Promise.all([
      new Promise<void>((resolve) => {
        if (pubClient.status === 'ready') {
          resolve()
        } else {
          pubClient.once('ready', () => resolve())
        }
      }),
      new Promise<void>((resolve) => {
        if (subClient.status === 'ready') {
          resolve()
        } else {
          subClient.once('ready', () => resolve())
        }
      }),
    ])

    this.adapterConstructor = createAdapter(pubClient, subClient)
  }

  createIOServer(port: number, options?: ServerOptions) {
    const server: Server = super.createIOServer(port, {
      ...options,
      cors: {
        origin: '*',
        credentials: true,
      },
    })
    
    server.use((socket, next) => {
      this.authMiddleware(socket, next)
        .then(() => {})
        .catch(() => {})
    })
    
    server.of(/.*/).use((socket, next) => {
      this.authMiddleware(socket, next)
        .then(() => {})
        .catch(() => {})
    })
    
    return server
  }

  async authMiddleware(socket: Socket, next: (err?: any) => void) {
    const { authorization } = socket.handshake.headers
    if (!authorization) {
      return next(new Error('Thiáº¿u Authorization header'))
    }
    
    const accessToken = authorization.split(' ')[1]
    if (!accessToken) {
      return next(new Error('Thiáº¿u access token'))
    }
    
    try {
      const { userId } = await this.tokenService.verifyAccessToken(accessToken)
      await socket.join(generateRoomUserId(userId))
      next()
    } catch (error) {
      next(error)
    }
  }
}
```

---

## ğŸ”§ BÆ¯á»šC 3: Cáº¬P NHáº¬T FILE `chat-redis.service.ts`

### 3.1. Má»Ÿ file

```bash
code src/websockets/services/chat-redis.service.ts
```

### 3.2. Thay Ä‘á»•i imports vÃ  type

```typescript
// âŒ XÃ“A
import { createClient, RedisClientType } from 'redis'

// âœ… THÃŠM
import Redis from 'ioredis'
```

### 3.3. Thay Ä‘á»•i property type

```typescript
// âŒ XÃ“A
private readonly redis: RedisClientType

// âœ… THÃŠM
private readonly redis: Redis
```

### 3.4. Cáº­p nháº­t constructor

```typescript
constructor() {
  // âœ… Khá»Ÿi táº¡o vá»›i ioredis
  this.redis = new Redis(envConfig.REDIS_URL, {
    retryStrategy: (times) => {
      const delay = Math.min(times * 50, 2000)
      return delay
    },
    maxRetriesPerRequest: 3,
    enableOfflineQueue: true,
  })

  // âœ… Event listeners
  this.redis.on('connect', () => {
    this.logger.log('Connected to Redis for chat cache')
  })

  this.redis.on('ready', () => {
    this.logger.log('Redis is ready for chat cache')
  })

  this.redis.on('error', (error) => {
    this.logger.error('Redis connection error:', error)
  })

  this.redis.on('close', () => {
    this.logger.warn('Redis connection closed')
  })

  this.redis.on('reconnecting', () => {
    this.logger.log('Reconnecting to Redis...')
  })

  // âŒ XÃ“A dÃ²ng nÃ y
  // this.redis.connect().catch(...)
}
```

### 3.5. TÃ¬m vÃ  thay tháº¿ `setEx` â†’ `setex`

**Sá»­ dá»¥ng Find & Replace trong VS Code:**

1. Má»Ÿ Find & Replace: `Ctrl + H` (Windows) hoáº·c `Cmd + H` (Mac)
2. Find: `this.redis.setEx`
3. Replace: `this.redis.setex`
4. Click "Replace All" trong file nÃ y

**Hoáº·c thá»§ cÃ´ng:**

```typescript
// âŒ TRÆ¯á»šC
await this.redis.setEx(userKey, 3600, JSON.stringify(currentSockets))

// âœ… SAU
await this.redis.setex(userKey, 3600, JSON.stringify(currentSockets))
```

**CÃ¡c chá»— cáº§n thay Ä‘á»•i:**
- Line ~55: `addOnlineUser()`
- Line ~81: `removeOnlineUser()`
- Line ~146: `setSocketUser()`
- Line ~197: `setUserTyping()`
- Line ~222: `removeUserTyping()`
- Line ~275: `cacheUserConversations()`

### 3.6. Cáº­p nháº­t method `disconnect()`

```typescript
async disconnect(): Promise<void> {
  try {
    // âœ… Sá»­ dá»¥ng quit() thay vÃ¬ disconnect()
    await this.redis.quit()
    this.logger.log('Disconnected from Redis')
  } catch (error) {
    this.logger.error('Error disconnecting from Redis:', error)
  }
}
```

---

## ğŸ”§ BÆ¯á»šC 4: KIá»‚M TRA VÃ€ TEST

### 4.1. Kiá»ƒm tra TypeScript errors

```bash
pnpm run build
```

### 4.2. Cháº¡y tests

```bash
# Unit tests
pnpm run test:unit

# Integration tests (náº¿u cÃ³)
pnpm run test:integration

# E2E tests
pnpm run test:e2e
```

### 4.3. Test thá»§ cÃ´ng

```bash
# Start Redis (náº¿u chÆ°a cháº¡y)
docker-compose up -d redis

# Start application
pnpm run start:dev
```

**Kiá»ƒm tra logs:**
- âœ… "Connected to Redis for chat cache"
- âœ… "Redis is ready for chat cache"
- âŒ KhÃ´ng cÃ³ errors

### 4.4. Test WebSocket connection

```javascript
// Test client
const socket = io('http://localhost:3000/chat', {
  auth: {
    authorization: 'Bearer YOUR_ACCESS_TOKEN'
  }
})

socket.on('connect', () => {
  console.log('âœ… Connected to WebSocket')
})

socket.on('error', (error) => {
  console.error('âŒ WebSocket error:', error)
})
```

---

## ğŸ”§ BÆ¯á»šC 5: CLEANUP (TÃ™Y CHá»ŒN)

### 5.1. Kiá»ƒm tra dependencies khÃ´ng sá»­ dá»¥ng

```bash
# Kiá»ƒm tra xem cÃ²n file nÃ o import tá»« 'redis' khÃ´ng
grep -r "from 'redis'" src/
grep -r 'from "redis"' src/
```

### 5.2. Remove package `redis` (náº¿u khÃ´ng cÃ²n dependency)

**âš ï¸ Cáº¢NH BÃO:** Chá»‰ remove náº¿u:
- `@keyv/redis` khÃ´ng phá»¥ thuá»™c vÃ o `redis`
- KhÃ´ng cÃ²n file nÃ o import tá»« `redis`

```bash
# Kiá»ƒm tra dependencies tree
pnpm why redis

# Náº¿u chá»‰ cÃ³ direct dependency, cÃ³ thá»ƒ remove
pnpm remove redis
```

---

## ğŸ“Š BÆ¯á»šC 6: MONITORING VÃ€ OPTIMIZATION

### 6.1. ThÃªm monitoring

```typescript
// Trong ChatRedisService constructor
this.redis.on('ready', () => {
  this.logger.log(`Redis ready - Status: ${this.redis.status}`)
})

this.redis.on('reconnecting', (delay) => {
  this.logger.warn(`Reconnecting to Redis in ${delay}ms...`)
})

this.redis.on('end', () => {
  this.logger.error('Redis connection ended')
})
```

### 6.2. Performance monitoring

```typescript
// ThÃªm method Ä‘á»ƒ monitor performance
async getStats(): Promise<any> {
  return {
    status: this.redis.status,
    options: {
      host: this.redis.options.host,
      port: this.redis.options.port,
      db: this.redis.options.db,
    },
  }
}
```

---

## âœ… CHECKLIST SAU KHI HOÃ€N THÃ€NH

- [ ] Code build thÃ nh cÃ´ng khÃ´ng errors
- [ ] All tests pass
- [ ] WebSocket connection hoáº¡t Ä‘á»™ng
- [ ] Chat features hoáº¡t Ä‘á»™ng (online status, typing indicators)
- [ ] Redis connection stable (check logs)
- [ ] Performance khÃ´ng giáº£m
- [ ] Commit changes vá»›i message rÃµ rÃ ng

---

## ğŸ› TROUBLESHOOTING

### Lá»—i 1: "Cannot find module 'ioredis'"

**Giáº£i phÃ¡p:**
```bash
pnpm install ioredis
```

### Lá»—i 2: "redis.setEx is not a function"

**NguyÃªn nhÃ¢n:** ChÆ°a Ä‘á»•i `setEx` â†’ `setex`

**Giáº£i phÃ¡p:** TÃ¬m vÃ  thay tháº¿ táº¥t cáº£ `setEx` â†’ `setex`

### Lá»—i 3: Connection timeout

**Giáº£i phÃ¡p:**
```typescript
const redis = new Redis(envConfig.REDIS_URL, {
  connectTimeout: 10000, // TÄƒng timeout
  retryStrategy: (times) => {
    if (times > 10) return null // Stop retry after 10 attempts
    return Math.min(times * 50, 2000)
  },
})
```

### Lá»—i 4: "READONLY" error

**Giáº£i phÃ¡p:**
```typescript
const redis = new Redis(envConfig.REDIS_URL, {
  reconnectOnError: (err) => {
    const targetError = 'READONLY'
    if (err.message.includes(targetError)) {
      return true // Reconnect on READONLY error
    }
    return false
  },
})
```

---

## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O

- [IORedis Documentation](https://github.com/redis/ioredis)
- [Socket.IO Redis Adapter](https://socket.io/docs/v4/redis-adapter/)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [NestJS WebSockets](https://docs.nestjs.com/websockets/gateways)

---

## ğŸ¯ Káº¾T LUáº¬N

Sau khi hoÃ n thÃ nh migration:
- âœ… Code sáº¡ch hÆ¡n vÃ  dá»… maintain
- âœ… Performance tá»‘t hÆ¡n
- âœ… Better TypeScript support
- âœ… Auto-reconnect vÃ  error handling tá»‘t hÆ¡n
- âœ… TÆ°Æ¡ng thÃ­ch vá»›i ecosystem NestJS

**Thá»i gian Æ°á»›c tÃ­nh:** 30-60 phÃºt

**Äá»™ khÃ³:** â­â­â˜†â˜†â˜† (Trung bÃ¬nh - Dá»…)

